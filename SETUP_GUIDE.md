# BrainBattle - Полная инструкция по настройке

## Что было реализовано

### 1. Система безопасности и защиты от взлома
- Серверная валидация всех игровых действий
- Anti-cheat система с автоматическим обнаружением читов
- Проверка целостности игрового состояния через checksums
- Система банов за нарушения (автоматическая и ручная)
- Логирование всех подозрительных действий

### 2. Система монетизации (реклама)
- Google AdSense интеграция
- Баннерная реклама (верх и низ экрана)
- Interstitial реклама (каждые 3 игры)
- Реклама с наградами (опционально)
- Трекинг показов рекламы в базе данных

### 3. Онлайн-режим (только online)
- Проверка интернет-соединения в реальном времени
- Блокировка оффлайн режима
- Ping-система для проверки связи с сервером
- Модальное окно при потере соединения
- Индикатор статуса подключения

### 4. Шифрование данных
- AES-256-GCM шифрование для чувствительных данных
- PBKDF2 хеширование паролей
- HMAC подписи для целостности данных
- Безопасные токены сессий

### 5. Rate Limiting (защита от злоупотреблений)
- Ограничение запусков игр (50/час)
- Ограничение matchmaking (100/час)
- Ограничение API запросов (1000/час)
- Ограничение обновлений профиля (10/час)

## Шаг 1: Настройка Supabase Database

### Выполните SQL скрипты
В Supabase SQL Editor выполните скрипты в следующем порядке:

1. `scripts/001_create_database_schema.sql` - основная схема базы данных
2. `scripts/002_add_security_tables.sql` - таблицы безопасности

Или используйте v0 для выполнения скриптов прямо из интерфейса.

## Шаг 2: Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Безопасность
ENCRYPTION_KEY=your_random_256_bit_key_here
ANTI_CHEAT_SECRET=your_random_secret_here

# Google AdSense
NEXT_PUBLIC_ADSENSE_CLIENT_ID=ca-pub-xxxxxxxxxxxxxxxx
NEXT_PUBLIC_ADSENSE_SLOT_TOP=xxxxxxxxxx
NEXT_PUBLIC_ADSENSE_SLOT_BOTTOM=xxxxxxxxxx
NEXT_PUBLIC_ADSENSE_SLOT_INTERSTITIAL=xxxxxxxxxx

# Dev redirect URL (для разработки)
NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL=http://localhost:3000
```

### Как получить значения:

#### Supabase
1. Перейдите в ваш Supabase проект
2. Settings → API
3. Скопируйте `URL` и `anon public` ключ

#### Ключи шифрования
Сгенерируйте случайные ключи:
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

#### Google AdSense
1. Зарегистрируйтесь на https://www.google.com/adsense
2. Создайте рекламные блоки для:
   - Баннер вверху (Top Banner)
   - Баннер внизу (Bottom Banner)
   - Interstitial реклама (полноэкранная)
3. Скопируйте Client ID и Slot ID для каждого блока

## Шаг 3: Настройка Supabase Authentication

1. В Supabase Dashboard → Authentication → Providers
2. Включите Email provider
3. В Authentication → URL Configuration:
   - Site URL: `https://your-domain.com`
   - Redirect URLs: добавьте `https://your-domain.com/auth/callback`

## Шаг 4: Row Level Security (RLS)

RLS политики уже включены в SQL скриптах. Убедитесь, что они активированы:

1. Supabase Dashboard → Database → Tables
2. Для каждой таблицы проверьте, что RLS enabled
3. Просмотрите политики в разделе Policies

## Шаг 5: Тестирование безопасности

### Проверьте anti-cheat систему:
1. Запустите игру
2. Попробуйте сделать быстрые ходы (< 100ms)
3. Проверьте таблицу `anti_cheat_logs` в Supabase

### Проверьте rate limiting:
1. Попробуйте запустить много игр подряд
2. После 50 игр в час должна появиться ошибка

### Проверьте онлайн-режим:
1. Откройте игру
2. Отключите интернет
3. Должно появиться модальное окно с предупреждением

## Шаг 6: Публикация

### На Vercel:
1. Push код в GitHub
2. Импортируйте проект в Vercel
3. Добавьте все environment variables
4. Deploy

### Настройка домена:
1. Vercel → Project Settings → Domains
2. Добавьте ваш домен
3. Обновите DNS записи

### После публикации:
1. Обновите Supabase Redirect URLs на ваш домен
2. Обновите Site URL в Supabase Auth
3. Проверьте работу рекламы на продакшене

## Шаг 7: Мониторинг

### Что отслеживать:

1. **Anti-cheat логи** (`anti_cheat_logs` таблица):
   - Частота нарушений
   - Типы нарушений
   - Паттерны читеров

2. **Баны** (`user_bans` таблица):
   - Количество забаненных пользователей
   - Причины банов

3. **Rate limits** (`rate_limits` таблица):
   - Кто превышает лимиты
   - Возможные DDoS атаки

4. **Реклама** (`ad_impressions` таблица):
   - Количество показов
   - Доход от рекламы (через AdSense dashboard)

## Безопасность в продакшене

### Обязательно:
- [ ] Измените все дефолтные ключи и секреты
- [ ] Включите HTTPS (автоматически на Vercel)
- [ ] Настройте CORS правильно
- [ ] Регулярно обновляйте зависимости
- [ ] Мониторьте логи ошибок
- [ ] Делайте бэкапы базы данных

### Рекомендуется:
- [ ] Настройте CDN для статических ресурсов
- [ ] Включите Vercel Analytics
- [ ] Настройте error tracking (Sentry)
- [ ] Добавьте rate limiting на Vercel edge
- [ ] Настройте DDoS protection

## Монетизация

### Оптимизация AdSense:
1. Анализируйте CTR (Click-Through Rate)
2. Экспериментируйте с placement рекламы
3. A/B тестирование частоты interstitial рекламы
4. Оптимизируйте размеры баннеров

### Дополнительные источники дохода:
- Premium подписка (без рекламы)
- Внутриигровые покупки
- Спонсорство
- Партнерские программы

## Поддержка пользователей

### Как пользователи могут связаться:
1. `/settings/help` - форма обратной связи
2. Email support (настройте в форме)
3. Discord/Telegram сообщество (опционально)

### Процесс апелляции бана:
1. Пользователь видит страницу `/banned`
2. Может связаться через форму поддержки
3. Вы проверяете `anti_cheat_logs`
4. Если бан ошибочный - удалите запись из `user_bans`

## Масштабирование

### Когда растет нагрузка:
1. Увеличьте rate limits
2. Оптимизируйте SQL запросы
3. Добавьте кеширование (Redis)
4. Разделите базу данных (read replicas)
5. Используйте CDN для игровых ресурсов

## Частые проблемы и решения

### Реклама не показывается:
- Проверьте ADSENSE_CLIENT_ID и SLOT_ID
- AdSense требует одобрения (может занять несколько дней)
- Проверьте консоль браузера на ошибки

### Пользователи не могут войти:
- Проверьте Supabase Auth настройки
- Проверьте redirect URLs
- Убедитесь, что email provider включен

### Anti-cheat слишком строгий:
- Увеличьте минимальное время между ходами (сейчас 100ms)
- Измените порог бана (сейчас 5 нарушений за 24 часа)

### Rate limit блокирует честных пользователей:
- Увеличьте лимиты в `lib/security/rate-limit.ts`
- Добавьте whitelist для VIP пользователей

## Следующие шаги

### Дополнительные фичи:
- [ ] Admin панель для модерации
- [ ] Система достижений
- [ ] Глобальный рейтинг
- [ ] Турниры и события
- [ ] Social sharing
- [ ] Push notifications
- [ ] Mobile apps (React Native)

## Контакты для поддержки

Если у вас возникли вопросы:
1. Проверьте документацию в `SECURITY_DOCUMENTATION.md`
2. Проверьте логи ошибок
3. Проверьте Supabase logs

---

**Поздравляем! Ваше приложение BrainBattle готово к запуску с полной защитой и монетизацией.**
